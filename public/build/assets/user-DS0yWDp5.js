var g=1;function h(a,n,o,r,e){localStorage.setItem("currentPage",a),g=a,$.ajax({url:"/api/users/searchUser?page="+a,method:"GET",data:{name:n,email:o,group_role:r,is_active:e,page:a},success:function(t){if(console.log(t),console.log(t.userList),$("#message").hide(),t.userList&&t.userList.length>0){$("#userTable tbody").empty(),$.each(t.userList,function(d,l){var i="<tr>";i+='<td><input type="checkbox" class="user-checkbox" data-id="'+l.id+'" /></td>',i+="<td>"+l.name+"</td>",i+="<td>"+l.email+"</td>",i+="<td>"+(l.group_role||"Chưa xác định")+"</td>",i+="<td>"+(l.is_active?'<span class="badge text-success">Đang hoạt động</span>':'<span class="badge text-danger">Tạm khoá</span>')+"</td>",i+="<td>",i+='<a href="javascript:void(0);" class="edit-btn" data-id="'+l.id+'" title="Sửa">',i+='<i class="bi bi-pencil-fill" style="color: #17a2b8; "></i></a> ',i+='<a href="javascript:void(0);"  class="delete-btn" data-id="'+l.id+'" title="Xóa">',i+='<i class="bi bi-trash-fill" style="color: #dc3545;"></i></a> ',i+='<a href="javascript:void(0);" class="block-btn" data-id="'+l.id+'" title="Block/Unblock">',i+='<i class="bi bi-person-fill-x" style="color: black"></i></a>',i+="</td>",i+="</tr>",$("#userTable tbody").append(i)}),$("#pagination-top").show(),$("#pagination-bottom").show();var s=(t.pagination.current_page-1)*t.pagination.per_page+1;console.log(s);var c=Math.min(t.pagination.current_page*t.pagination.per_page,t.pagination.total);$("#start-index").text(s),$("#end-index").text(c),$("#total-users").text(t.pagination.total),t.pagination.total<=10?($("#pagination-top").hide(),$("#pagination-bottom").hide()):(p("#pagination-top",t.pagination.current_page,t.pagination.last_page),p("#pagination-bottom",t.pagination.current_page,t.pagination.last_page))}else $("#userTable tbody").empty(),$("#userTable tbody").append('<tr><td colspan="6" class="text-center">Không có người dùng nào.</td></tr>'),$("#pagination-top").hide(),$("#pagination-bottom").hide()},error:function(t,s,c){let d="Đã xảy ra lỗi.";if(t.responseJSON){const l=t.responseJSON;if(d=l.message||d,l.errors){const i=Object.values(l.errors).flat().join(`
`);d+=`
`+i}}Swal.fire({icon:"error",title:"Lỗi!",text:d})}})}function p(a,n,o){const r=$(a);n=n,$(a).html(""),n>1&&r.append('<a href="#" class="page-control prev" data-page="'+(n-1)+'">‹</a> ');for(var e=1;e<=o;e++)e==n?$(a).append('<a href="#" class="page active" data-page="'+e+'">'+e+"</a> "):$(a).append('<a href="#" class="page" data-page="'+e+'">'+e+"</a> ");n<o&&r.append('<a href="#" class="page-control next" data-page="'+(n+1)+'">›</a>'),r.find("a.page, a.page-control").off("click").on("click",function(t){t.preventDefault();var s=$("#search-status").val();s==="Đang Hoạt Động"?s=1:s==="Tạm Khoá"?s=0:s="";const c=$(this).data("page");h(c,$("#search-name").val(),$("#search-email").val(),$("#search-group").val(),s)})}$("#add-new-button").click(function(){$("#addUserForm")[0].reset(),$("#addMessage").hide().text(""),$("#addUserModalLabel").text("Thêm Người Dùng Mới"),$("#saveUserBtn").data("mode","add"),$("#addUserModal").modal("show")});$("#saveUserBtn").click(function(a){a.preventDefault();const n=$("#add-password").val(),o=$("#add-confirm-password").val(),r=$("#add-name").val(),e=$("#add-email").val(),t=$("#add-group").val();var s=$("#add-status").val();if(console.log(e),s==="Đang Hoạt Động"?s=1:s=0,console.log("o day tra is active",s),n!==o){Swal.fire({icon:"error",title:"Mật khẩu không khớp",text:"Mật khẩu và xác nhận mật khẩu không giống nhau!"});return}const c=$(this).data("mode"),d=$(this).data("user-id");let l="";c==="edit"?l="/api/users/updateUser/"+d:l="/api/users/addUser",$.ajax({url:l,type:"POST",dataType:"json",data:{name:r,email:e,password:n,group_role:t,is_active:s},success:function(i){console.log("Phản hồi từ server:",i),i&&i.message?i.message.includes("thành công")?Swal.fire({icon:"success",title:"Thành công!",text:i.message,timer:2e3,showConfirmButton:!1}).then(()=>{$("#addUserModal").modal("hide"),h(g,"","","","")}):Swal.fire({icon:"error",title:"Lỗi!",text:i.message}):Swal.fire({icon:"error",title:"Lỗi!",text:"Không nhận được phản hồi từ server."})},error:function(i,m,x){let u="Đã xảy ra lỗi.";if(i.responseJSON){const f=i.responseJSON;if(u=f.message||u,f.errors){const v=Object.values(f.errors).flat().join(`
`);u+=`
`+v}}Swal.fire({icon:"error",title:"Lỗi!",text:u})}})});$("#search-button").click(function(){var a=$("#search-name").val(),n=$("#search-email").val(),o=$("#search-group").val(),r=$("#search-status").val(),e=/[!#$%^&*(),?":{}|<>]/g;if(e.test(a)){Swal.fire({icon:"warning",title:"Ký tự không hợp lệ!",text:"Vui lòng không nhập các ký tự đặc biệt!"}),$("#search-name").val("");return}if(e.test(n)){Swal.fire({icon:"warning",title:"Ký tự không hợp lệ!",text:"Vui lòng không nhập các ký tự đặc biệt!"}),$("#search-email").val("");return}console.log("isActive value before sending:",r),r==="Đang Hoạt Động"?r=1:r==="Tạm Khoá"?r=0:r="",g=1,h(g,a,n,o,r)});$(document).on("click",".delete-btn",function(){var a=$(this).data("id"),n=$("#search-name").val(),o=$("#search-email").val(),r=$("#search-group").val(),e=$("#search-status").val();e==="Đang Hoạt Động"?e=1:e==="Tạm Khoá"?e=0:e="",console.log(e),Swal.fire({title:"Bạn có chắc chắn?",text:"Bạn sẽ không thể hoàn tác sau khi xóa!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Xóa",cancelButtonText:"Huỷ"}).then(t=>{t.isConfirmed&&$.ajax({url:"/api/users/delete/"+a,type:"POST",dataType:"json",data:{userId:a},success:function(s){console.log(s),s.status.includes("Success")?(Swal.fire("Đã xoá!","Người dùng đã được xoá thành công.","success"),h(g,n,o,r,e)):Swal.fire("Lỗi!",s.message||"Xóa người dùng thất bại!","error")},error:function(s,c,d){console.log("Lỗi khi xóa người dùng:",d),Swal.fire("Lỗi hệ thống!","Không thể xóa người dùng do lỗi máy chủ.","error")}})})});$("#clear-button").click(function(){$("#search-name").val(""),$("#search-email").val(""),$("#search-group").val(""),$("#search-status").val(""),g=1,h(g,"","","","")});h(1,"","","","");$.ajaxSetup({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}});$(document).on("click",".edit-btn",function(){var a=$(this).data("id");$.ajax({url:"api/users/getUserByID/"+a,type:"GET",dataType:"json",data:{userId:a},success:function(n){if(console.log(" Response từ server:",n.user),n&&n.user){const o=n.user;console.log(" Dữ liệu người dùng nhận được:",o),$("#add-name").val(o.name),$("#add-email").val(o.email),$("#add-group").val(o.group_role),console.log(o.is_active),console.log("o day tra user"+o.is_active),o.is_active===0?$("#add-status").val("Tạm Khoá"):$("#add-status").val("Đang Hoạt Động"),$("#addUserModalLabel").text("Chỉnh sửa người dùng"),$("#saveUserBtn").data("mode","edit").data("user-id",o.id),$("#addMessage").hide().text(""),$("#addUserModal").modal("show")}},error:function(){alert("Không thể tải dữ liệu người dùng.")}})});$("#delete-selected").on("click",function(){const a=$(".user-checkbox:checked").map(function(){return $(this).data("id")}).get();if(a.length===0){Swal.fire("Thông báo","Vui lòng chọn ít nhất một người dùng để xoá.","info");return}a.join(","),Swal.fire({title:"Bạn chắc chắn?",text:`Bạn muốn xoá ${a.length} người dùng?`,icon:"warning",showCancelButton:!0,confirmButtonText:"Xoá",cancelButtonText:"Huỷ"}).then(n=>{n.isConfirmed&&$.ajax({url:"/api/users/deleteSelectedUsers",type:"POST",data:JSON.stringify({user_ids:a}),contentType:"application/json",dataType:"json",success:function(o){console.log(o),o.status.includes("Success")?(Swal.fire({title:"Xoá người dùng thành công",icon:"success",confirmButtonText:"OK"}),$("#check-all").prop("checked",!1),h(1,"","","","")):Swal.fire({title:"Lỗi khi xoá người dùng!",icon:"error",confirmButtonText:"OK"})},error:function(){Swal.fire({title:"Lỗi khi xoá người dùng!",icon:"error",confirmButtonText:"OK"})}})})});$(document).on("change","#select-all",function(){var a=$(this).prop("checked");$(".user-checkbox").prop("checked",a)});$(document).on("click",".block-btn",function(){var a=$(this).data("id");$(this);var n=$("#search-name").val(),o=$("#search-email").val(),r=$("#search-group").val(),e=$("#search-status").val();e==="Đang Hoạt Động"?e=1:e==="Tạm Khoá"?e=0:e="",$.ajax({url:"api/users/blockUser/"+a,type:"POST",dataType:"json",data:{userId:a},success:function(t){console.log("Phản hồi từ server:",t),console.log("Phản hồi từ server:",t.is_active),t.status.includes("Success")?h(g,n,o,r,e):alert("Lỗi khi thay đổi trạng thái người dùng!")},error:function(t,s,c){console.log("Lỗi khi thay đổi trạng thái người dùng:",c),alert("Lỗi khi thay đổi trạng thái người dùng!")}})});
