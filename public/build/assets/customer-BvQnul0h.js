var d=1;function u(t,s,n,a,o){localStorage.setItem("currentPage",t),d=t,$.ajax({url:"/api/customers/searchCustomer?page="+t,type:"GET",dataType:"json",data:{page:t,customer_name:s,email:n,address:a,is_active:o},success:function(e){if(console.log(e),$("#message").hide(),e&&e.customerList&&e.customerList.length>0){$("#customerTable tbody").empty(),$.each(e.customerList,function(h,c){var l="<tr>";l+="<td>"+c.customer_name+"</td>",l+="<td>"+c.email+"</td>",l+="<td>"+(c.address||"")+"</td>",l+="<td>"+(c.tel_num||"")+"</td>",l+="<td>",l+='<a href="javascript:void(0);" class="edit-btn" data-id="'+c.customer_id+'" title="Sửa">',l+='<i class="bi bi-pencil-fill" style="color: #17A2B8;"></i></a> ',l+="</td>",l+="</tr>",$("#customerTable tbody").append(l)}),$("#pagination-top").show(),$("#pagination-bottom").show();var i=(e.pagination.current_page-1)*e.pagination.per_page+1;console.log(i);var r=Math.min(e.pagination.current_page*e.pagination.per_page,e.pagination.total);$("#start-index").text(i),$("#end-index").text(r),$("#total-customers").text(e.pagination.total),e.pagination.total<=10?($("#pagination-top").hide(),$("#pagination-bottom").hide()):(f("#pagination-top",e.pagination.current_page,e.pagination.last_page),f("#pagination-bottom",e.pagination.current_page,e.pagination.last_page))}else $("#customerTable tbody").empty(),$("#customerTable tbody").append('<tr><td colspan="6" class="text-center">Không có khách hàng nào.</td></tr>'),$("#pagination-top").hide(),$("#pagination-bottom").hide()},error:function(e,i,r){$("#message").text("Lỗi khi tải danh sách khách hàng!").show(),$("#customerTable tbody").empty()}})}u(1,"","","","");function f(t,s,n){const a=$(t);s=s,$(t).html(""),s>1&&a.append('<a href="#" class="page-control prev" data-page="'+(s-1)+'">‹</a> ');for(var o=1;o<=n;o++)o==s?$(t).append('<a href="#" class="page active" data-page="'+o+'">'+o+"</a> "):$(t).append('<a href="#" class="page" data-page="'+o+'">'+o+"</a> ");s<n&&a.append('<a href="#" class="page-control next" data-page="'+(s+1)+'">›</a>'),a.find("a.page, a.page-control").off("click").on("click",function(e){e.preventDefault();var i=$("#search-status").val();i==="Đang Hoạt Động"?i=1:i==="Tạm Khoá"?i=0:i="";const r=$(this).data("page");u(r,$("#search-name").val(),$("#search-email").val(),$("#search-address").val(),i)})}$("#search-button").click(function(){var t=$("#search-name").val(),s=$("#search-email").val(),n=$("#search-address").val(),a=$("#search-status").val(),o=/[!#$%^&*(),?":{}|<>]/g;if(console.log(t),o.test(t)){Swal.fire({icon:"warning",title:"Ký tự không hợp lệ!",text:"Vui lòng không nhập các ký tự đặc biệt!"}),$("#search-name").val("");return}if(o.test(s)){Swal.fire({icon:"warning",title:"Ký tự không hợp lệ!",text:"Vui lòng không nhập các ký tự đặc biệt!"}),$("#search-email").val("");return}if(o.test(n)){Swal.fire({icon:"warning",title:"Ký tự không hợp lệ!",text:"Vui lòng không nhập các ký tự đặc biệt!"}),$("#search-address").val("");return}d=1,console.log("isActive value before sending:",a),a==="Đang Hoạt Động"?a=1:a==="Tạm Khoá"?a=0:a="",console.log("isActive value before sending:",a),u(d,t,s,n,a)});$("#clear-button").click(function(){$("#search-name").val(""),$("#search-email").val(""),$("#search-address").val(""),$("#search-status").val(""),d=1,u(d,"","","","")});$("#add-new-customer-button").click(function(){$("#addCustomerForm")[0].reset(),$("#addCustomerMessage").hide().text(""),$("#addCustomerModalLabel").text("Thêm Khách Hàng Mới"),$("#addCustomerModal").modal("show")});$("#saveCustomerBtn").click(function(t){t.preventDefault();var s=$("#customer-name").val(),n=$("#customer-email").val(),a=$("#customer-address").val(),o=$("#customer-phone").val(),e=$("#customer-status").val();e==="Đang Hoạt Động"?e=1:e==="Tạm Khoá"?e=0:e="",$.ajax({url:"/api/customers/addCustomer",type:"POST",dataType:"json",data:{customer_name:s,email:n,address:a,tel_num:o,is_active:e},success:function(i){console.log("Phản hồi từ server:",i),console.log("Phản hồi từ server:",i.message),i&&i.message?i.message.includes("thành công")?Swal.fire({icon:"success",title:"Thành công!",text:i.message,timer:2e3,showConfirmButton:!1}).then(()=>{$("#addCustomerModal").modal("hide"),u(d,"","","","")}):Swal.fire({icon:"error",title:"Lỗi!",text:i.message}):Swal.fire({icon:"error",title:"Lỗi!",text:"Không nhận được phản hồi từ server."})},error:function(i,r,h){let c="Đã xảy ra lỗi.";if(i.responseJSON){const l=i.responseJSON;if(c=l.message||c,l.errors){const m=Object.values(l.errors).flat().join(`
`);c+=`
`+m}}Swal.fire({icon:"error",title:"Lỗi!",text:c})}})});$(document).on("click",".save-inline",function(){const t=$(this).closest("tr"),s=$(this).data("id");console.log("ID:",s);const n=t.find('input[data-field="customerName"]').val().trim(),a=t.find('input[data-field="email"]').val().trim(),o=t.find('input[data-field="address"]').val().trim(),e=t.find('input[data-field="telNum"]').val().trim();if(console.log("Lưu:",n,a,o,e),!n||!a||!o||!e){Swal.fire({icon:"warning",title:"Cảnh báo!",text:"Vui lòng nhập dầy đủ thông tin khách hàng"});return}if(!/^[0-9]{10,11}$/.test(e)){Swal.fire({icon:"warning",title:"Cảnh báo!",text:"Số điện thoại phải có từ 9-11 số"});return}$.ajax({url:"api/customers/updateCustomer/"+s,type:"POST",dataType:"json",data:{customer_name:n,email:a,address:o,tel_num:e},success:function(r){console.log("Phản hồi server:",r),r&&r.message.includes("thành công")?(t.find("td:eq(0)").text(n),t.find("td:eq(1)").text(a),t.find("td:eq(2)").text(o),t.find("td:eq(3)").text(e),t.find("td:eq(4)").html(`
                <a href="javascript:void(0);" class="edit-btn" data-id="${s}" title="Sửa">
                   <i class="bi bi-pencil-fill" style="color: #17A2B8;"></i>
                </a>
`),t.removeClass("editing")):alert(r.message||"Không thể cập nhật khách hàng.")},error:function(r,h,c){let l="Đã xảy ra lỗi.";if(r.responseJSON){const m=r.responseJSON;if(l=m.message||l,m.errors){const g=Object.values(m.errors).flat().join(`
`);l+=`
`+g}}Swal.fire({icon:"error",title:"Lỗi!",text:l})}})});$(document).on("click",".edit-btn",function(){const t=$(this).closest("tr"),s=$(this).data("id");if(t.hasClass("editing"))return;t.addClass("editing");const n=t.find("td:eq(0)").text().trim(),a=t.find("td:eq(1)").text().trim(),o=t.find("td:eq(2)").text().trim(),e=t.find("td:eq(3)").text().trim();console.log(n);const i=$('<input type="text" class="form-control form-control-sm" data-field="customerName">').val(n),r=$('<input type="email" class="form-control form-control-sm" data-field="email">').val(a),h=$('<input type="text" class="form-control form-control-sm" data-field="address">').val(o),c=$('<input type="text" class="form-control form-control-sm" data-field="telNum">').val(e);t.find("td:eq(0)").html(i),t.find("td:eq(1)").html(r),t.find("td:eq(2)").html(h),t.find("td:eq(3)").html(c);const l=$('<button class="btn btn-sm btn-success save-inline">Lưu</button>');l.attr("data-id",s);const m=$('<button class="btn btn-sm btn-secondary cancel-inline">Hủy</button>');t.find("td:eq(4)").html("").append(l).append(m)});$(document).on("click",".cancel-inline",function(){$(this).closest("tr"),Swal.fire({title:"Bạn có chắc chắn muốn hủy chỉnh sửa?",icon:"warning",showCancelButton:!0,confirmButtonText:"Đồng ý",cancelButtonText:"Không"}).then(t=>{t.isConfirmed&&window.location.reload()})});$(document).on("click","#import-excel-btn",function(t){t.preventDefault(),$("#excel-file").click()});$("#excel-file").on("change",function(){let t=$("#excelUploadForm")[0],s=new FormData(t);$("#search-name").val(),$("#search-email").val(),$("#search-address").val(),$("#search-status").val(),console.log("File:",s.get("excelFile")),$.ajax({url:"/customers/import",type:"POST",data:s,contentType:!1,processData:!1,success:function(n){console.log(n),console.log(n.message),n.message.includes("thành công")?Swal.fire({icon:"success",title:"Thành công!",text:n.message,timer:2e3,showConfirmButton:!1}).then(()=>{d=1,u(d,"","","","")}):Swal.fire({icon:"error",title:"Lỗi!",text:n.message})},error:function(n,a,o){let e="Đã xảy ra lỗi.";if(n.responseJSON){const i=n.responseJSON;if(e=i.message||e,i.errors){const r=Object.values(i.errors).flat().join(`
`);e+=`
`+r}}Swal.fire({icon:"error",title:"Lỗi!",text:e})}})});$("#export-excel-btn").click(function(){let t=$("#search-name").val(),s=$("#search-email").val(),n=$("#search-address").val(),a=$("#search-status").val();a==="Đang Hoạt Động"?a=1:a==="Tạm Khoá"?a=0:a="";let o=$.param({currentPage:d,name:t,email:s,address:n,isActive:a});window.location.href="/customers/export?"+o});$.ajaxSetup({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}});
